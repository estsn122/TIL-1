# Railsで学ぶセッションとCookie（初心者向けVer）/Runteq

## 「Cookie」とはブラウザに保存される小さな情報またはその領域
開発者ツールで確認してみよう

## 「Session」とは、サーバー側で一時的に保持できる情報またはその領域。仮のテーブルみたいなもの。
※後述するが、Railsの標準では、Sessionの情報はサーバではなく、Cookieに保存されているというのが厳密。

## 「HTTP」は「ステートレスな性質」を持つ。
#### ステートレスとは「状態を持たない」ということ。一つ一つのリクエストは独立している。<br>
→サーバは1回目のリクエストと2回目のリクエストを別物として捉える。関連するリクエストとして扱ってくれない。

## Cookieとセッションを組み合わせるとユーザを特定できる。
セッション情報がサーバ側で生成される。セッションIDというサーバが独自に発行する一意な情報で、今回はkeyを「0001」とする。(セッションID：0001  ユーザID：1というテーブル)

## 処理のフロー
1. ログインページを表示するようリクエストを投げる。
2. ログインページを返す
3. メールアドレスとパスワードを送る
4. 送られてきた情報をもとにユーザを探して来て、セッションにその情報を格納する。
```ruby
user = User.find_by(email: params[:email])
if user&.authenticate(params[:password])
  session[:user_id] = user.id
end

# user&.authenticateは、userがnilの場合実行されない。
```
5. サーバは、セッションID「0001」をCookieに保存するようクライアントに指示する。
6. ログイン後のページに遷移するとともに、セッションIDをCookieに保存する
7. いいねをするリクエストを投げる。そのリクエストを送る際に、Cookieに保存されている「0001」も一緒にサーバに送る。
8. サーバは送られてきたセッションID「0001」を元にセッション情報を検索しにいく。0001に該当する1行を発見！ユーザIDは１だ！
```ruby
# session[:user_id] => 1
user = User.find_by(id: session[:user_id])
```
毎回取るの面倒やし、current_userっていう名前のメソッドにしちゃおう。<br>
→汎用的な処理はGem(sorcery, deviseなど)にまとめてしまおう。
```ruby
def current_user
  User.find_by(id: session[:user_id])
end
```

### ログイン チョットワカル生徒「セッションとかCookieにユーザの情報を保存することで、異なるHTTPリクエストに繋がりを持たせることを「ログイン」と言うんだな」
→ログインとは「異なるHTTPリクエストに繋がりを持たせること」というのが厳密に正しい意味。

## ログイン機能意外にどんなところでセッションを使いますか？
・ステップフォーム＝複数のページにまたがって情報を入力するフォーム(申し込みフォームなど)<br>
→セッションに保存しておこう。<br>
→(セッションID、ユーザID、姓名、お届け先)

## 「サーバは、セッションID0001をCookieに保存するようクライアントに指示する。」なんて処理かいてないよ？
セッションIDの受け渡しについては、Railsがよしなにやってくれる。

### それでも詳しく説明すると…
ブラウザは、サーバからSet-Cookieヘッダを受け取ると、その内容をブラウザのCookieに保存する。データは`name=value`の形式になっている。<br>
→このSet-Cookieの受け渡しまで考える必要はない。一応検証ツールで確認できる。<br>
→もちろん明示的にCookieを指定することもできる。（Railsチュートリアルでいう記憶トークンのこと）

## セッションIDをどうやってサーバに渡してるの？
ブラウザがよしなにやってくれる。<br>
→HTTPリクエストにCookieの情報も勝手に載せてくれる。<br>

まとめると…
- サーバからブラウザにセッションIDを送る方法…HTTPレスポンスのSet-Cookieヘッダに埋め込む。
- ブラウザからサーバにセッションIDを送る方法…HTTPリクエストにCookieをのせる(Cookieの一部にセッションIDが含まれている)

## セッションの保存先
実はRailsの標準では保存する場所がない<br>
→Cookieに保存させちゃえ！<br>
→厳密に言うと、Railsは「セッションIDだけじゃなくセッション情報全てをCookieに載せて受け渡している」

## セッション情報の保存
- cookie_store：Railsのデフォルト
session情報すべてがブラウザに表示されるから、他人に見られると成りすまされちゃうかも。<br>
→coockieの情報が一度漏洩すると、もう防ぎようがない。

- インメモリ(RedisなどのDB)：セッションIDはcookieに入れて、セッション情報はDBに保存する。早いし、安全性が高まる。
AWSのElastic cacheとかがある。<br>

（※開発環境ではcookie_store、production環境ではインメモリにするとよい。）

## 参考になる資料
- [Railsのセッション管理には何が最適か](https://qiita.com/shota_matsukawa_ga/items/a21c5cf49a1de6c9561a)
- [Webセッションとは何か？ついでにクッキーとは何か？](https://tadtadya.com/web-what-is-a-session/)
